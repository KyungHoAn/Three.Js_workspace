<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <link rel="stylesheet" href="./vaz.css">
    <title>Three.js - Fundamentals with light</title>
  </head>
<body>
    <script type="importmap">
        {
            "imports" : {
                "three" : "../build/three.module.js",
                "OrbitControls" : "./jsm/controls/OrbitControls.js",
                "three/examples/jsm/libs/stats.module": "../examples/jsm/libs/stats.module.js",
                "OBJLoader" :"./jsm/loaders/OBJLoader.js",
                "GLTFLoader":"./jsm/loaders/GLTFLoader.js",
                "GUI":"./jsm/libs/lil-gui.module.min.js",
                "MTLLoader":"./jsm/loaders/MTLLoader.js"
            }
        }
    </script>
    <script type="module">
        import * as THREE from 'three'
        import { OrbitControls } from 'OrbitControls'
        import { GUI } from 'GUI'
        import { OBJLoader } from 'OBJLoader'
        import {MTLLoader} from 'MTLLoader'
        import {GLTFLoader} from 'GLTFLoader'

        const scene = new THREE.Scene()
        const camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 1000)
        const TRAY = document.getElementById('js-tray-slide')

        const canvas = document.querySelector('#c')
        const clock = new THREE.Clock()
        const gui = new GUI()

        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true })
        let autoE = false
        renderer.setSize(window.innerWidth, window.innerHeight)
        renderer.shadowMap.enabled = true
        renderer.setPixelRatio(window.devicePixelRatio)
        renderer.shadowMap.type = THREE.PCFSoftShadowMap
        document.body.appendChild(renderer.domElement)

        const controls = new OrbitControls(camera, renderer.domElement)
        // controls.maxPolarAngle = Math.PI/2
        // controls.minPolarAngle = Math.PI/3
        // controls.enablePan = false
        // controls.dampingFactor = 0.1
        // controls.autoRotate = false
        // controls.autoRotateSpeed = 0.2
        function setCamera() {
            camera.position.set(10,5,17)
            controls.enableDamping = true
            // controls.minDistance = 1
            // controls.maxDistance = 10
            controls.update()
        }
        setCamera()
        let loader = new GLTFLoader()

        const vaz = await loader.loadAsync('./vaz/scene.gltf')
        const vaz2 = await loader.loadAsync('./vaz/scene.gltf')
        // const vaz = await loader.loadAsync('./vaz/vaz-2105.glb')
        let theModel = vaz.scene
        let matModel = vaz2.scene
        scene.add(theModel)

        theModel.traverse((o)=> {
            if(o.isMesh) {
                o.castShadow = true
                o.receiveShadow = true
            }
        })

        let ambientLight
        // let ambientLight = new THREE.AmbientLight(0xffffff,300)
        // scene.add(ambientLight)
        let hemiLight = new THREE.HemisphereLight(0xffffff,0xffffff,0.61)
        hemiLight.position.set(0,50,0)
        scene.add(hemiLight)

        let dirLight = new THREE.DirectionalLight(0xffffff,0.54)
        dirLight.position.set(-8,12,8)
        dirLight.castShadow = true
        dirLight.shadow.mapSize = new THREE.Vector2(1024,1024)
        scene.add(dirLight)

        const background_color = 0xf1f1f1
        scene.background = new THREE.Color(background_color)
        scene.fog = new THREE.Fog(background_color,20,100)

        //Floor
        // let floorGeometry = new THREE.PlaneGeometry(5000,5000,1,1)
        // let floorMaterial = new THREE.MeshPhongMaterial({
        //     color: 0xeeeeee,
        //     shininess:0
        // })
        // let floor = new THREE.Mesh(floorGeometry, floorMaterial)
        // floor.rotation.x = -0.5*Math.PI
        // floor.receiveShadow = true
        // floor.position.y = -1
        // scene.add(floor)

        const colors = [ {color:'66533C'}, {color:'173A2F'}, {color:'153944'}, {color:'27548D'}, {color:'438AAC'} ]

        function buildColors(colors) {
            for (let [i, color] of colors.entries()) {
                let swatch = document.createElement('div')
                swatch.classList.add('tray__swatch')
                swatch.style.background = "#" + color.color
                swatch.setAttribute('data-key', i)
                TRAY.append(swatch)
            }
        }
        buildColors(colors)

        // Swatches
        const swatches = document.querySelectorAll(".tray__swatch")
        for (const swatch of swatches) {
            swatch.addEventListener('click', selectSwatch)
        }

        let carBody = theModel.children[0].children[0].children[0].children[1].children[0].material.color

        function selectSwatch(e) {
            let color = colors[parseInt(e.target.dataset.key)]
            let new_mtl
            new_mtl = new THREE.MeshPhongMaterial({
                color:parseInt('0x'+color.color),
                shininess: color.shininess?color.shininess: 10
            })
            setMaterialColor(theModel,new_mtl)
        }

        function setMaterialColor(parent, mtl) {
            carBody.r = mtl.color.r
            carBody.g = mtl.color.g
            carBody.b = mtl.color.b
        }

        let props = {
            firstCamera: false,
            secondCamera: false,
            thirdCamera: false,
            fourthCamera: false,
        }

        const gltfFolder = gui.addFolder("camera")
        let moveCamera = gltfFolder.add(props,'firstCamera').name('firstMove').listen()
        moveCamera.onChange(
            function(e) {
                if(e == true) {
                    props.secondCamera = false
                    props.thirdCamera = false
                    props.fourthCamera = false
                    firstLocation()
                } else {
                    setCamera()
                }
            }
        )
        let cuteCamera = gltfFolder.add(props,'secondCamera').name('cuteMove').listen()
        cuteCamera.onChange(
            function(e) {
                if(e == true) {
                    props.firstCamera = false
                    props.thirdCamera = false
                    props.fourthCamera = false
                    cuteLocation()
                } else {
                    setCamera()
                }
            }
        )
        let carDnCamera = gltfFolder.add(props,'thirdCamera').name('carDnMove').listen()
        carDnCamera.onChange(
            function(e) {
                if(e == true) {
                    props.firstCamera = false
                    props.secondCamera = false
                    props.fourthCamera = false
                    carDn()
                } else {
                    setCamera()
                }
            }
        )
        let carDnCamera2 = gltfFolder.add(props, 'fourthCamera').name('carDnMove2').listen()
        carDnCamera2.onChange(
            function(e) {
                if(e == true) {
                    props.firstCamera = false
                    props.secondCamera = false
                    props.thirdCamera = false
                    carDn2()
                } else {
                    setCamera()
                }
            }
        )
        function firstLocation() {
            camera.position.set(-0.3084007032967616, 2.170361374179901, -1.5484965123508034)
            camera.rotation.set(-3.0741919664475184, -0.04268037329315125, -3.138712485629328)
        }
        function cuteLocation() {
            camera.position.set(0.049280145157820913, 1.8263274174864204, 0.22265007992236185)
            camera.rotation.set(-3.0344866460178874, 0.09798769704992441, 3.1310745046794355)
        }
        function carDn() {
            camera.position.set(2.459045966438709, -2.1421204839954684, 5.410323829811498)
            camera.rotation.set(0.8048158948029703, 0.5412204083012035, -0.4917114459662305)
        }
        function carDn2() {
            camera.position.set(1.3166716447391558, -1.877716388867218, -3.13906436539053)
            camera.rotation.set(2.105251008301363, 0.5339095515382513, -2.4314631483182185)
        }

        
        const modelFolder = gui.addFolder("Model Inspector")
        // 기본 color
        props.baseButton = function() {
            sceneReset()
            theModel.traverse(function(child) {
                if(child.isMesh) {
                    child.remove(child.children[0])     // wireframe
                    child.material.opacity = .2         // opactiy
                    child.material.metalness = 0        // metalness
                    child.material.roughness = 0        // roughness
                }
            })
        }
        let baseBtn = modelFolder.add(props, 'baseButton').name('Base Color')

        // 금속성
        props.metalnessButton = function() {
            sceneReset()
            theModel.traverse(function(child) {
                if(child.isMesh) {
                    child.remove(child.children[0])     // wireframe
                    child.material.opacity = .2         // opacity
                    child.material.metalness = 10       // metalness
                    child.material.roughness = 0        // roughness
                }
            })
        }
        let metalnessBtn = modelFolder.add(props,'metalnessButton').name('Metalness')

        // 거칠기
        props.roughnessButton = function() {
            sceneReset()
            theModel.traverse(function(child) {
                if(child.isMesh) {
                    child.remove(child.children[0])     // wireframe
                    child.material.opacity = .2         // opacity
                    child.material.metalness = 0        // metalness
                    child.material.roughness = 10       // roughness
                }
            })
        }
        let roughnessBtn = modelFolder.add(props,'roughnessButton').name('Roughness')

        // 노멀 맵
        props.normalButton = function() {
            sceneReset()
            theModel.traverse(function(child) {
                if(child.isMesh) {
                    child.remove(child.children[0])     // wireframe
                    child.material.opacity = .2         // opactiy
                    child.material.metalness = 0        // metalness
                    child.material.roughness = 0        // roughness

                    // let ambientLight = new THREE.AmbientLight(0xffffff,300)
                    // scene.add(ambientLight)

                    // if(child.material.normalMap != null) {
                    //     const normalTexture = new THREE.TextureLoader().load(
                    //         './vaz/normalMap.jpg'
                    //     )
                    //     child.material.normalMap = normalTexture
                    // }
                }                
            })
        }
        let normalBtn = modelFolder.add(props,'normalButton').name('Normal Map')

        // 불투명
        props.opacityButton = function() {
            sceneReset()
            theModel.traverse(function(child) {
                if(child.isMesh) {
                    child.remove(child.children[0])     // wireframe
                    child.material.opacity = .7         // opactiy
                    child.material.metalness = 0        // metalness
                    child.material.roughness = 0        // roughness
                }
            })
            // ambientLight = new THREE.AmbientLight(0xffffff,300)
            // scene.add(ambientLight)
        }
        let opacityBtn = modelFolder.add(props,'opacityButton').name('Opacity')

        // 빛 x
        props.emissionButton = function() {
            if(scene.name == 'mat') {
                scene.remove(matModel)
                scene.add(theModel)
                scene.name = ''
            }
            theModel.traverse(function(child) {
                if(child.isMesh) {
                    child.remove(child.children[0])     // wireframe
                    child.material.opacity = .2         // opacity
                    child.material.metalness = 0        // metalness
                    child.material.roughness = 0        // roughness
                }
            })
            scene.remove(hemiLight)
            scene.remove(dirLight)
            scene.remove(ambientLight)
        }
        let emissionBtn = modelFolder.add(props, 'emissionButton').name('Emission')

        const geometryFolder = gui.addFolder("geometry")
        // matcap
        props.matcapButton = function() {
            if(scene.name == ''){
                scene.remove(theModel)
                scene.add(matModel)
                scene.name = 'mat'
            }
            scene.add(hemiLight)
            scene.add(dirLight)
            scene.remove(ambientLight)
            matModel.traverse(function(child) {
                if(child.isMesh) {
                    child.remove(child.children[0])     // wireframe
                    child.material.opacity = .2         // opacity
                    child.material.metalness = 0        // metalness
                    child.material.roughness = 0        // roughness
                    let matcapMaterial = new THREE.MeshMatcapMaterial()
                    child.material = matcapMaterial
                }
            })
        }
        let matcapBtn = geometryFolder.add(props, 'matcapButton').name('Matcap')

        // wireframe
        props.wireframeButton = function() {
            sceneReset()
            theModel.traverse(function(child) {
                if(child.isMesh) {
                    child.material.opacity = .2         // opacity
                    child.material.metalness = 0        // metalness
                    child.material.roughness = 0        // roughness
                    if(child.children == '') {
                        let wireframeGeometry = new THREE.WireframeGeometry(child.geometry)
                        let wireframeMaterial = new THREE.LineBasicMaterial({color:0xffffff})
                        let wireframe = new THREE.LineSegments(wireframeGeometry, wireframeMaterial)
                        child.add(wireframe)
                    }
                }
            })
        }
        let wireframeBtn = geometryFolder.add(props,'wireframeButton').name('Wireframe')

        function sceneReset() {
            if(scene.name == 'mat'){
                scene.remove(matModel)
                scene.add(theModel)
                scene.name = ''
            }
            scene.add(hemiLight)
            scene.add(dirLight)
            scene.remove(ambientLight)
        }
        
        function animate() {
            requestAnimationFrame(animate)
            // vaz.scene.children[0].rotation.z += 0.001
            // console.log(camera.position)
            // console.log(camera.rotation)
            renderer.render(scene, camera)
        }        
        animate()

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight
            camera.updateProjectionMatrix()
            renderer.setSize(window.innerWidth, window.innerHeight)
        }
        window.addEventListener('resize', onWindowResize)
    </script>
    <canvas id="c"></canvas>
    <div class="controls">
        <div id="js-tray" class="tray">
            <div id="js-tray-slide" class="tray__slide"></div>
        </div>
    </div>
</body>
</html>